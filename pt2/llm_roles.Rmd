---
title: 'Deliberative Reasoning with(in) the Machine: Large-Language Models as Proxy for Collective Deliberation'
author: "Nardine Alnemr, Francesco Veri, Gustavo Umbelino"
date: "`r Sys.Date()`"
bibliography: ../bibliography/refs.bib
link-citations: true
csl: ../bibliography/apsa.csl
output:
  html_document: default
  pdf_document: default
  md_document:
    variant: markdown_github
---

# Install ```deliberr``` package
```{r deliberr}

# install.packages("gumbelino/deliberr")
library(deliberr)
lsf.str("package:deliberr")

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readr)
library(readxl)
library(dplyr)
library(rstatix)
library(tidyr)
library(ggplot2)
library(psych)
library(gridExtra)
library(ggpubr)


LLM_DATA_DIR <- "../llm_data"
SURVEY_FILE <- "../data/surveys_v5.xlsx"
EXEC_LOG_FILE <- paste(LLM_DATA_DIR, "exec_log.csv", sep = "/")
LLMS_FILE <- "../private/pt2_llms.csv"
CASES_FILE <- "../data/deliberative_cases.csv"
PROMPTS_FILE <- "../prompts/prompts.csv"
OUTPUT_DIR <- "pt2/data"

```

# Overview of data for analysis of LLM roles
## Large-Language Models (LLMs) Preview

```{r models, warning=FALSE}

# get models info
models <- read_csv(LLMS_FILE, show_col_types = FALSE) %>%
  filter(included) %>% # only included "included" models]
  mutate(class = case_when(
    estimate > 1 ~ "top",
    estimate <= 1 ~"bottom",
    .default = "new")
  )

models %>%
  select(provider, model, class) %>% 
  arrange(desc(class), provider, model) %>%
  knitr::kable(caption = "LLMs", row.names = TRUE, col.names = c("Provider", "Model", "Class"))

models_top <- models %>%
  filter(class != "bottom")

models_bottom <- models %>%
  filter(class == "bottom")

```

Building on our previous analysis, we selected only top models. gemini-2.5-flash substituted the gemini-2.5-pro-preview-03-25, which is not supported anymore. The _pro_ version was too slow to include in this analysis, so it was replaced with the _flash_ version.

## Cases

```{r cases, warning=FALSE}

cases <- read_csv(CASES_FILE, show_col_types = FALSE)

cases %>% arrange(survey) %>%
  knitr::kable(caption = "Deliberative Cases", row.names = TRUE)

```

Also building on our previous analysis, we selected only deliberative cases.

## Surveys

```{r surveys, warning=FALSE}

# get deliberative survey names
survey_names <- unique(cases$survey)

get_surveys <- function(survey_names) {
  
  surveys <- list()
  
  # Iterate over each sheet in the workbook
  for (survey_name in survey_names) {

    # Read the current sheet into a data frame
    df <- read_excel(SURVEY_FILE, sheet = survey_name)
    
    # Check if required columns exist
    required_columns <- c("considerations", "policies", "scale_max", "q-method")
    missing_cols <- setdiff(required_columns, colnames(df))
    if (length(missing_cols) > 0) {
      cat(
        "Sheet",
        survey_name,
        "is missing the following columns:",
        paste(missing_cols, collapse = ", "),
        "\n\n"
      )
      next
    }
    
    # Calculate the number of non-NA rows in "considerations" column
    n_c <- sum(!is.na(df$considerations))
    
    # Calculate the number of non-NA rows in "policies" column
    n_p <- sum(!is.na(df$policies))
    
    # Extract integer values from "scale_max" column, assuming they are already integers
    scale_max <- as.integer(na.omit(df$scale_max))
    
    # Extract logical (boolean) values from "q-method" column
    q_method <- as.logical(na.omit(df$`q-method`))
    
    surveys[[length(surveys) + 1]] <- tibble(
      survey = survey_name,
      considerations = n_c,
      policies = n_p,
      scale_max,
      q_method,
    )
    
  }
  
  surveys <- bind_rows(surveys)
  surveys
  
}

surveys <- get_surveys(survey_names)

surveys %>% arrange(survey) %>%
  knitr::kable(caption = "Surveys", row.names = TRUE)

```

Note that two of the cases share the same survey.

## Roles (System Prompts)

```{r prompts, warning=FALSE}

prompts <- read_csv(PROMPTS_FILE, show_col_types = FALSE)

prompts %>% 
  group_by(type) %>%
  summarise(n = n(), .groups = "drop") %>%
  knitr::kable(caption = "Number of Prompts by Type")

prompts %>% arrange(type) %>%
  select(-article) %>%
  knitr::kable(caption = "System Prompts", row.names = TRUE)

```

## Summary of LLM Data Collection

```{r format LLM data, include=FALSE}

# source("get_llm_data.R")

llm_data <- read_csv("data/llm_data_clean.csv", show_col_types = FALSE)

```
We collected a total of `r nrow(llm_data)` LLM responses from `r nrow(models)` models across `r nrow(surveys)` surveys and `r nrow(prompts)` roles. We prompted each LLM 5 times with the same prompt.


# Climate Analysis
```{r climate}
# get cases
cc_cases <- cases %>% 
  filter(topic == "climate", survey != "fnqcj", survey != "forestera")
# we remove fnqcj and forestera because they are not consistent with our roles

# get surveys
cc_surveys <- unique(cc_cases$survey)

# get roles: ecologist ideology, climate perspectives, or devil's advocate
cc_roles <- prompts %>% filter(type != "ideology" | uid == "eco")

cc_cases %>%
  knitr::kable(caption = "Subset of cases used in the climate analysis", row.names = TRUE)

cc_roles %>%
  knitr::kable(caption = "Subset of roles used in the climate analysis", row.names = TRUE)


```

```{r}

cc_llm_data <- llm_data %>%
  filter(survey %in% cc_surveys, prompt_uid %in% cc_roles$uid)

cc_llm_data %>%
  group_by(model) %>%
  summarize(n = n())

```

For the climate analysis, we selected a subset of `r nrow(cc_llm_data)` responses generated by `r nrow(models)` models cross `r length(cc_surveys)` surveys and `r nrow(cc_roles)` roles described above. We prompted each LLM 5 times with the same prompt.

We calculated one DRI value per model/survey/role by treating each LLM response as one participant in a deliberation. The role "all" indicates that all roles were part of that deliberation (n = 60 participants, which equals 5 participants for each of the 12 roles). See example below.

```{r, include=FALSE}
res <- list()
plots <- list()


for (model in models$model) {

  for (survey in cc_surveys) {
  
    data <- llm_data %>% filter(model == !!model, survey == !!survey, prompt_uid %in% cc_roles$uid) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    ic <- get_dri_ic(data)
    dri <- get_dri(ic)
    alpha <- get_dri_alpha(data)
    
    title <- paste(model, survey, sep = "/")
    # suffix <- paste("all", nrow(cc_roles), "climate roles")
    plot <- plot_dri_ic(ic, title, dri = dri)
    
    file_name <- paste0(model, "-", survey, ".png")
    
    # ggsave(
    #   paste("plots", file_name, sep="/"),
    #   plot,
    #   width = 8,
    #   height = 6
    # )
    plots[[length(plots)+1]] <- plot
    
    res[[length(res)+1]] <- tibble(
      model,
      survey,
      role = "all",
      dri,
      alpha,
      n = nrow(data),
    )
    
    
    for (role in cc_roles$uid) {
      
      data <- llm_data %>%
        filter(model == !!model, survey == !!survey, prompt_uid == role) %>%
        mutate(pnum = row_number()) # treat each response as a participant
      ic <- get_dri_ic(data)
      dri <- get_dri(ic) 
      alpha <- get_dri_alpha(data)
      
      res[[length(res)+1]] <- tibble(
        model,
        survey,
        role,
        dri,
        alpha,
        n = nrow(data),
      )
      
    }
    
    
    
  }
  
}

res <- bind_rows(res)

```

## Consistency results

### Top models
```{r}

cplots <- list()

res %>%
  arrange(model, survey, role) %>%
  head(5) %>%
  knitr::kable(caption = "Head (5) of DRI consistency cross climate roles", digits = 3)

res_top <- res %>%
  filter(model %in% models_top$model)

role_dri <- res_top %>%
  group_by(role) %>%
  get_summary_stats(type = "common") %>%
  filter(variable == "dri") %>%
  arrange(median)
  
order <- role_dri$role

res_top %>%
  ggboxplot(x = "role", y = "dri", title = "Distribution of DRI across climate roles", order = order, caption = "Each role has 12 data points: 4 models x 3 surveys", xlab = "Role", ylab = "DRI") + geom_hline(yintercept = 0, linetype = 2, color = "red") -> plot

cplots[[length(cplots)+1]] <- plot


role_alpha_p <- res_top %>%
  group_by(role) %>%
  get_summary_stats(type = "common") %>%
  filter(variable == "alpha_p") %>%
  arrange(median)
  
order <- role_alpha_p$role

res_top %>%
  ggboxplot(x = "role", y = "alpha_p", title = "Distribution of Cronbach's alpha (policies) across climate roles", order = order, caption = "Each role has 12 data points: 4 models x 3 surveys", xlab = "Role", ylab = "Cronbach's Alpha (policies)") -> plot

cplots[[length(cplots)+1]] <- plot


# res_top %>%
#   group_by(role) %>%
#   get_summary_stats(type = "common") %>%
#   filter(variable != "n") %>%
#   arrange(variable, -mean) %>%
#   knitr::kable(caption = "Consistency data (DRI and Cronbach's alpha)", digits = 3, row.names = TRUE)

```

### Bottom models
```{r}

res_bottom <- res %>%
  filter(model %in% models_bottom$model)

role_dri <- res_bottom %>%
  group_by(role) %>%
  get_summary_stats(type = "common") %>%
  filter(variable == "dri") %>%
  arrange(median)
  
order <- role_dri$role

res_bottom %>%
  ggboxplot(x = "role", y = "dri", title = "Distribution of DRI across climate roles", order = order, caption = "Each role has 12 data points: 4 models x 3 surveys", xlab = "Role", ylab = "DRI") + geom_hline(yintercept = 0, linetype = 2, color = "red") -> plot

cplots[[length(cplots)+1]] <- plot

role_alpha_p <- res_bottom %>%
  group_by(role) %>%
  get_summary_stats(type = "common") %>%
  filter(variable == "alpha_p") %>%
  arrange(median)
  
order <- role_alpha_p$role

res_bottom %>%
  ggboxplot(x = "role", y = "alpha_p", title = "Distribution of Cronbach's alpha (policies) across climate roles", order = order, caption = "Each role has 12 data points: 4 models x 3 surveys", xlab = "Role", ylab = "Cronbach's Alpha (policies)") -> plot

cplots[[length(cplots)+1]] <- plot



# res_bottom %>%
#   group_by(role) %>%
#   get_summary_stats(type = "common") %>%
#   filter(variable != "n") %>%
#   arrange(variable, -mean) %>%
#   knitr::kable(caption = "Consistency data (DRI and Cronbach's alpha)", digits = 3, row.names = TRUE)

```

```{r, fig.width=14, fig.height=6}

grid.arrange(grobs = cplots, nrow = 2, ncol = 2)

```


Note that each role has 12 data points: 3 surveys x 4 models.

We found that LLMs are consistent across roles both in terms of DRI and Cronbach's Alpha (policies). The high DRI across roles (median = `r role_dri[role_dri$role == "all",]$median`; IQR = `r role_dri[role_dri$role == "all",]$iqr`) suggests that LLMs tend to consistenly align their considerations and policy preferences. The high Cronbach's alpha for their policy preferences (median = `r role_alpha_p[role_alpha_p$role == "all",]$median`; IQR = `r role_alpha_p[role_alpha_p$role == "all",]$iqr`) suggests that LLMs tend to agree on the ranking of their policy preferences.


## Summary for model

```{r dri-summary}
model_role_summary <- res %>%
  group_by(model, role) %>%
  summarise(mean_dri = mean(dri), .groups = "drop") %>%
  pivot_wider(names_from = model, values_from = mean_dri)


# find best model for each row
model_role_summary$best <- 
  colnames(model_role_summary)[max.col(model_role_summary[, -1],
                                       ties.method = "first") + 1]

model_role_summary %>%
  knitr::kable(caption = "Mean DRI across models and roles", digits = 3, row.names = TRUE)


```


## Summary Cronbach's Alpha (Policies)
```{r}
model_role_summary <- res %>%
  group_by(model, role) %>%
  summarise(mean_alpha_p = mean(alpha_p), .groups = "drop") %>%
  pivot_wider(names_from = model, values_from = mean_alpha_p)


# find best model for each row
model_role_summary$best <- 
  colnames(model_role_summary)[max.col(model_role_summary[, -1],
                                       ties.method = "first") + 1]

model_role_summary %>%
  knitr::kable(caption = "Mean alpha (policies) across models and roles", digits = 3, row.names = TRUE)


```


## Summary Cronbach's Alpha (Consideration)
```{r}
model_role_summary <- res %>%
  group_by(model, role) %>%
  summarise(mean_alpha_c = mean(alpha_c), .groups = "drop") %>%
  pivot_wider(names_from = model, values_from = mean_alpha_c)


# find best model for each row
model_role_summary$best <- 
  colnames(model_role_summary)[max.col(model_role_summary[, -1],
                                       ties.method = "first") + 1]

model_role_summary %>%
  knitr::kable(caption = "Mean alpha (considerations) across models and roles", digits = 3, row.names = TRUE)


```


## Detailed data
```{r}

res %>%
  arrange(model, survey, role) %>%
  knitr::kable(caption = "DRI consistency cross 12 climate roles", digits = 3, row.names = TRUE)

```

## Model/Survey DRI Plots
```{r, fig.width=15, fig.height=40}

# Arrange in 4 rows x 5 columns
grid.arrange(grobs = plots,
             nrow = 8,
             ncol = 3,
             widths = rep(1, 3),
             heights = rep(1, 8)) -> plot

ggsave(
  paste("plots", "all_plots.png", sep="/"),
  plot,
  width = 15,
  height = 40
)

```


## Survey/Role DRI Plots

### Top models
```{r, include=FALSE}

res <- list()
plots <- list()

for (role in cc_roles$uid) {

  for (survey in cc_surveys) {
    
    data <- llm_data %>%
      filter(survey == !!survey, prompt_uid == role, model %in% models_top$model) %>%
      mutate(pnum = row_number()) # treat each response as a participant
    ic <- get_dri_ic(data)
    dri <- get_dri(ic)
    alpha <- get_dri_alpha(data)
    
    title <- paste(role, survey, sep = "/")
    plot <- plot_dri_ic(ic, title, dri = dri)
    
    file_name <- paste0(role, "-", survey, ".png")
    

    plots[[length(plots)+1]] <- plot
    
    res[[length(res)+1]] <- tibble(
      role,
      survey,
      dri,
      alpha,
      n = nrow(data),
    )
    
  }
  
}

res <- bind_rows(res)


```


```{r, fig.width=15, fig.height=60}

# Arrange in 4 rows x 5 columns
grid.arrange(grobs = plots,
             nrow = 12,
             ncol = 3,
             widths = rep(1, 3),
             heights = rep(1, 12))

# ggsave(
#   paste("plots", "all_role_plots.png", sep="/"),
#   plot,
#   width = 5,
#   height = 12
# )

```

### Bottom models
```{r, include=FALSE}

res <- list()
plots <- list()

for (role in cc_roles$uid) {

  for (survey in cc_surveys) {
    
    data <- llm_data %>%
      filter(survey == !!survey, prompt_uid == role, model %in% models_bottom$model) %>%
      mutate(pnum = row_number()) # treat each response as a participant
    ic <- get_dri_ic(data)
    dri <- get_dri(ic)
    alpha <- get_dri_alpha(data)
    
    title <- paste(role, survey, sep = "/")
    plot <- plot_dri_ic(ic, title, dri = dri)
    
    file_name <- paste0(role, "-", survey, ".png")
    

    plots[[length(plots)+1]] <- plot
    
    res[[length(res)+1]] <- tibble(
      role,
      survey,
      dri,
      alpha,
      n = nrow(data),
    )
    
  }
  
}

res <- bind_rows(res)


```


```{r, fig.width=15, fig.height=60}

# Arrange in 4 rows x 5 columns
grid.arrange(grobs = plots,
             nrow = 12,
             ncol = 3,
             widths = rep(1, 3),
             heights = rep(1, 12))

# ggsave(
#   paste("plots", "all_role_plots.png", sep="/"),
#   plot,
#   width = 5,
#   height = 12
# )

```

# Permutation tests

```{r}

ITERATIONS = 10

```



## Surveys and Roles: Are models trully consistent across roles?

In this first permutation test, we explore the likelihood that the consistency, measured by DRI, is due to chance.

```{r, fig.width=8, fig.height=12}
perms <- list()
summs <- list()

for (survey in cc_surveys) {
  
  for (role in cc_roles$uid) {
    
    # get data
    data <- llm_data %>% filter(survey == !!survey, prompt_uid == role) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    
    # get raw permutation data for plotting
    perm <- permute_dri(data, iterations = ITERATIONS, summary = FALSE)
    perm$survey <- survey
    perm$role <- role
    
    perms[[length(perms)+1]] <- perm
    
    # get summary for table
    summ <- summarize_perm_dri(perm)
    summ$survey <- survey
    summ$role <- role
    
    summs[[length(summs)+1]] <- summ

  }
  
}

perms <- bind_rows(perms)
summs <- bind_rows(summs)


perms %>%
  gghistogram(
    x = "dri",
    facet.by = c("role", "survey"),
    fill = "source",
    add = "mean",
    rug = TRUE,
    title = "Survey/Role Permutation Test",
    caption = paste(ITERATIONS, "permutations"),
  ) -> plot

plot

summs %>%
  group_by(role) %>%
  summarise(sig = sum(p < 0.05)) %>%
  arrange(sig) %>%
  knitr::kable(caption = "Number of significant (p < 0.05) roles across the 3 surveys.", digits = 3)

summs %>%
  group_by(survey) %>%
  summarise(sig = sum(p < 0.05)) %>%
  arrange(sig) %>%
  knitr::kable(caption = "Number of significant (p < 0.05) surveys across the 12 roles", digits = 3)


summs %>%
  arrange(p) %>%
  knitr::kable(caption = "Survey/Role Permutation Summary", digits = 3)
  
```


## Models and Surveys: Which models are consistent across roles?

```{r, fig.width=12, fig.height=10}
perms <- list()
summs <- list()
for (survey in cc_surveys) {
  
  for (model in models$model) {
    
    # get data (for climate roles only)
    data <- llm_data %>% filter(model == !!model, survey == !!survey, prompt_uid %in% cc_roles$uid) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    
    # get raw permutation data for plotting
    perm <- permute_dri(data, iterations = ITERATIONS, summary = FALSE)
    perm$survey <- survey
    perm$model <- model
    
    perms[[length(perms)+1]] <- perm
    
    # get summary for table
    summ <- summarize_perm_dri(perm)
    summ$survey <- survey
    summ$model <- model
    
    summs[[length(summs)+1]] <- summ

  }
  
}

perms <- bind_rows(perms)
summs <- bind_rows(summs)


perms %>%
  gghistogram(
    x = "dri",
    facet.by = c("model", "survey"),
    fill = "source",
    add = "mean",
    rug = TRUE,
    title = "Survey/Model Permutation Test",
    caption = paste(ITERATIONS, "permutations"),
  ) -> plot


plot

summs %>%
  arrange(p) %>%
  knitr::kable(caption = "Survey/Model Permutation Summary", digits = 3)
  
```

All models seem to be consistent across roles. None of the 10,000 permutations led to a higher DRI than the _observed_ DRI, suggesting that the observed value is likely not due to chance.


# References
