---
title: 'Deliberative Reasoning with(in) the Machine: Large-Language Models as Proxy for Collective Deliberation'
author: "Nardine Alnemr, Francesco Veri, Gustavo Umbelino"
date: "`r Sys.Date()`"
bibliography: ../bibliography/refs.bib
link-citations: true
csl: ../bibliography/apsa.csl
output:
  html_document: default
  pdf_document: default
  md_document:
    variant: markdown_github
---

```{r deliberr, include=FALSE}

# install.packages("gumbelino/deliberr")
library(deliberr)
lsf.str("package:deliberr")

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readr)
library(readxl)
library(dplyr)
library(rstatix)
library(tidyr)
library(ggplot2)
library(psych)
library(gridExtra)
library(ggpubr)


LLM_DATA_DIR <- "../llm_data"
SURVEY_FILE <- "../data/surveys_v5.xlsx"
EXEC_LOG_FILE <- paste(LLM_DATA_DIR, "exec_log.csv", sep = "/")
LLMS_FILE <- "../private/pt2_llms.csv"
CASES_FILE <- "../data/deliberative_cases.csv"
PROMPTS_FILE <- "../prompts/prompts.csv"
OUTPUT_DIR <- "pt2/data"

```

# Large-Language Models (LLMs) Preview

```{r models, warning=FALSE}

# get models info
models <- read_csv(LLMS_FILE, show_col_types = FALSE) %>%
  filter(included) # only included "included" models

models %>%
  select(provider, model) %>% 
  arrange(provider, model) %>%
  knitr::kable(caption = "LLMs", row.names = TRUE, col.names = c("Provider", "Model"))

```

Building on our previous analysis, we selected only top models.

# Cases

```{r cases, warning=FALSE}

cases <- read_csv(CASES_FILE, show_col_types = FALSE)

cases %>% arrange(survey) %>%
  knitr::kable(caption = "Deliberative Cases", row.names = TRUE)

```

Also building on our previous analysis, we selected only deliberative cases.

# Surveys

```{r surveys, warning=FALSE}

# get deliberative survey names
survey_names <- unique(cases$survey)

get_surveys <- function(survey_names) {
  
  surveys <- list()
  
  # Iterate over each sheet in the workbook
  for (survey_name in survey_names) {

    # Read the current sheet into a data frame
    df <- read_excel(SURVEY_FILE, sheet = survey_name)
    
    # Check if required columns exist
    required_columns <- c("considerations", "policies", "scale_max", "q-method")
    missing_cols <- setdiff(required_columns, colnames(df))
    if (length(missing_cols) > 0) {
      cat(
        "Sheet",
        survey_name,
        "is missing the following columns:",
        paste(missing_cols, collapse = ", "),
        "\n\n"
      )
      next
    }
    
    # Calculate the number of non-NA rows in "considerations" column
    n_c <- sum(!is.na(df$considerations))
    
    # Calculate the number of non-NA rows in "policies" column
    n_p <- sum(!is.na(df$policies))
    
    # Extract integer values from "scale_max" column, assuming they are already integers
    scale_max <- as.integer(na.omit(df$scale_max))
    
    # Extract logical (boolean) values from "q-method" column
    q_method <- as.logical(na.omit(df$`q-method`))
    
    surveys[[length(surveys) + 1]] <- tibble(
      survey = survey_name,
      considerations = n_c,
      policies = n_p,
      scale_max,
      q_method,
    )
    
  }
  
  surveys <- bind_rows(surveys)
  surveys
  
}

surveys <- get_surveys(survey_names)

surveys %>% arrange(survey) %>%
  knitr::kable(caption = "Surveys", row.names = TRUE)

```

Note that two of the cases share the same survey.

# Roles (System Prompts)

```{r prompts, warning=FALSE}

prompts <- read_csv(PROMPTS_FILE, show_col_types = FALSE)

prompts %>% 
  group_by(type) %>%
  summarise(n = n(), .groups = "drop") %>%
  knitr::kable(caption = "Number of Prompts by Type")

prompts %>% arrange(type) %>%
  select(-article) %>%
  knitr::kable(caption = "System Prompts", row.names = TRUE)

```

# LLM Data Collection

```{r format LLM data, include=FALSE}

# source("get_llm_data.R")

llm_data <- read_csv("data/llm_data_clean.csv", show_col_types = FALSE)

```
We collected a total of `r nrow(llm_data)` LLM responses from `r nrow(models)` models across `r nrow(surveys)` surveys and `r nrow(prompts)` roles. We prompted each LLM 5 times with the same prompt.

```{r}



```


# Climate Analysis
```{r climate}
# get cases
cc_cases <- cases %>% 
  filter(topic == "climate", survey != "fnqcj", survey != "forestera")
# we remove fnqcj and forestera because they are not consistent with our roles

# get surveys
cc_surveys <- unique(cc_cases$survey)

# get roles: ecologist ideology, climate perspectives, or devil's advocate
cc_roles <- prompts %>% filter(type != "ideology" | uid == "eco")

cc_cases %>%
  knitr::kable(caption = "Subset of cases used in the climate analysis", row.names = TRUE)

cc_roles %>%
  knitr::kable(caption = "Subset of roles used in the climate analysis", row.names = TRUE)


```


```{r, include=FALSE}
res <- list()
plots <- list()


for (survey in cc_surveys) {
  
  for (model in models$model) {
    
    data <- llm_data %>% filter(model == !!model, survey == !!survey) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    ic <- get_dri_ic(data)
    dri <- get_dri(ic)
    alpha <- get_dri_alpha(data)
    
    title <- paste(model, survey, sep = "/")
    # suffix <- paste("all", nrow(cc_roles), "climate roles")
    plot <- plot_dri_ic(ic, title, DRI = dri)
    
    file_name <- paste0(model, "-", survey, ".png")
    
    # ggsave(
    #   paste("plots", file_name, sep="/"),
    #   plot,
    #   width = 8,
    #   height = 6
    # )
    plots[[length(plots)+1]] <- plot
    
    res[[length(res)+1]] <- tibble(
      model,
      survey,
      role = "all",
      dri,
      alpha,
      n = nrow(data),
    )
    
    
    for (role in cc_roles$uid) {
      
      data <- llm_data %>%
        filter(model == !!model, survey == !!survey, prompt_uid == role) %>%
        mutate(pnum = row_number()) # treat each response as a participant
      ic <- get_dri_ic(data)
      dri <- get_dri(ic) 
      alpha <- get_dri_alpha(data)
      
      res[[length(res)+1]] <- tibble(
        model,
        survey,
        role,
        dri,
        alpha,
        n = nrow(data),
      )
      
    }
    
    
    
  }
  
}

res <- bind_rows(res)

# res %>%
#   arrange(model, survey, role) %>%
#   knitr::kable(caption = "DRI consistency cross 12 climate roles", digits = 3)

```

## Model/Survey DRI Plots
```{r, fig.width=20, fig.height=15}

# Arrange in 4 rows x 5 columns
grid.arrange(grobs = plots,
             nrow = 3,
             ncol = 4,
             widths = rep(1, 4),
             heights = rep(1, 3)) -> plot

ggsave(
  paste("plots", "all_plots.png", sep="/"),
  plot,
  width = 20,
  height = 15
)

```


## Summary consistency

```{r}

res %>%
  group_by(role) %>%
  get_summary_stats(type = "common") %>%
  select(-n) %>%
  arrange(variable, -mean) %>%
  knitr::kable(caption = "Mean DRI across models", digits = 3, row.names = TRUE)

```

## Summary for model

```{r dri-summary}
model_role_summary <- res %>%
  group_by(model, role) %>%
  summarise(mean_dri = mean(dri), .groups = "drop") %>%
  pivot_wider(names_from = model, values_from = mean_dri)


# find best model for each row
model_role_summary$best <- 
  colnames(model_role_summary)[max.col(model_role_summary[, -1],
                                       ties.method = "first") + 1]

model_role_summary %>%
  knitr::kable(caption = "Mean DRI across models and roles", digits = 3, row.names = TRUE)


```


## Summary Cronbach's Alpha (Policies)
```{r}
model_role_summary <- res %>%
  group_by(model, role) %>%
  summarise(mean_alpha_p = mean(alpha_p), .groups = "drop") %>%
  pivot_wider(names_from = model, values_from = mean_alpha_p)


# find best model for each row
model_role_summary$best <- 
  colnames(model_role_summary)[max.col(model_role_summary[, -1],
                                       ties.method = "first") + 1]

model_role_summary %>%
  knitr::kable(caption = "Mean alpha (policies) across models and roles", digits = 3, row.names = TRUE)


```


## Summary Cronbach's Alpha (Consideration)
```{r}
model_role_summary <- res %>%
  group_by(model, role) %>%
  summarise(mean_alpha_c = mean(alpha_c), .groups = "drop") %>%
  pivot_wider(names_from = model, values_from = mean_alpha_c)


# find best model for each row
model_role_summary$best <- 
  colnames(model_role_summary)[max.col(model_role_summary[, -1],
                                       ties.method = "first") + 1]

model_role_summary %>%
  knitr::kable(caption = "Mean alpha (considerations) across models and roles", digits = 3, row.names = TRUE)


```


## Detailed data
```{r}

res %>%
  arrange(model, survey, role) %>%
  knitr::kable(caption = "DRI consistency cross 12 climate roles", digits = 3, row.names = TRUE)

```

## DRI for all

```{r}



```

```{r, include=FALSE}

res <- list()
plots <- list()

for (role in cc_roles$uid) {

  for (survey in cc_surveys) {
    
    data <- llm_data %>% filter(survey == !!survey, prompt_uid == role) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    ic <- get_dri_ic(data)
    dri <- get_dri(ic)
    alpha <- get_dri_alpha(data)
    
    title <- paste(role, survey, sep = "/")
    plot <- plot_dri_ic(ic, title, DRI = dri)
    
    file_name <- paste0(role, "-", survey, ".png")
    

    plots[[length(plots)+1]] <- plot
    
    res[[length(res)+1]] <- tibble(
      role,
      survey,
      dri,
      alpha,
      n = nrow(data),
    )
    
  }
  
}

res <- bind_rows(res)


```


## Survey/Role DRI Plots
```{r, fig.width=15, fig.height=60}

# Arrange in 4 rows x 5 columns
grid.arrange(grobs = plots,
             nrow = 12,
             ncol = 3,
             widths = rep(1, 3),
             heights = rep(1, 12))

# ggsave(
#   paste("plots", "all_role_plots.png", sep="/"),
#   plot,
#   width = 5,
#   height = 12
# )

```

# Permutation tests

```{r}

ITERATIONS = 10000

# test_data <- llm_data %>% filter(model == "grok-3-beta", survey == "ccps") %>%
#         mutate(pnum = row_number()) # treat each response as a participant
# 
# test <- tibble(
#   C1 = c(1,2,3,4),
#   C2 = c(2,3,4,3),
#   C3 = c(3,2,4,2),
#   C4 = c(4,3,3,1),
#   P1 = c(1,2,3,3),
#   P2 = c(2,3,1,2),
#   P3 = c(3,1,2,1),
# )
# 
# test_data <- test %>%
#   mutate(pnum = row_number()) # treat each response as a participant
# 
# test_perm <- permute_dri(test_data, iterations = 10, summary = FALSE)
# test_perm$model <- "model"
# test_perm$survey <- "survey"
# 
# # test_perm %>% 
# #   mutate()
# #   group_by(model, survey) %>%
# #   summarise()
# 
# ic <- get_dri_ic(test_data)
# plot_dri_ic(ic, DRI = get_dri(ic))
# 
# pref_cols <- grep("^P\\d", names(test_data), value = TRUE)
# shuffled_data <- test_data
# 
# shuffled_data[pref_cols] <- 
#   shuffled_data[sample(1:nrow(shuffled_data)), pref_cols]
# 
# ic <- get_dri_ic(shuffled_data)
# plot_dri_ic(ic, DRI = get_dri(ic))

```


```{r}
summarize_perm_dri <- function(data, type = "common") {
  
  # get observed dri
  obs_dri <- perm[perm$source == "observed",]$dri
  
  # get all permutations
  perm_dri <- perm[perm$source == "permutation",]
  
  # get permutation summary
  perm_summ <- perm_dri %>% 
    mutate(perm_dri = dri) %>%
    select(perm_dri) %>%
    get_summary_stats(type = type) %>%
    select(-variable)
  
  # calculate p
  p <- nrow(perm_dri %>% filter(dri >= obs_dri)) / nrow(perm_dri)
  
  # compile summary
  summ <- tibble(
    obs_dri,
    p,
    perm_summ
  )
  
  return(summ)

}

permute_dri <- function(data, iterations = 10000, verbose = FALSE, summary = TRUE) {
  set.seed(123)
  res <- list()
  
  # GET OBSERVED DRI
  ic <- get_dri_ic(data)
  obs_dri <- get_dri(ic)
  
  raw <- tibble(
    dri = obs_dri,
    source = "observed",
  )
  
  # RUN PERMUTATION
  # get preferences
  pref_cols <- grep("^P\\d", names(data), value = TRUE)
  shuffled_data <- data
  dri_shuffle <- list()
  
  time_start <- Sys.time()

  # permutation loop
  for (i in 1:iterations) {
    
    # shuffle preferences
    shuffled_data[pref_cols] <- 
      shuffled_data[sample(1:nrow(shuffled_data)), pref_cols]
    
    # get DRI
    ic <- get_dri_ic(shuffled_data)
    dri <- get_dri(ic)
    
    dri_shuffle[[length(dri_shuffle) + 1]] <- tibble(
      dri,
      source = "permutation",
      iteration = i
    )
    
  }
  
  time_end <- Sys.time()
  
  elapsed_time <- format(difftime(time_end, time_start, units = "auto"), digits = 3)
  
  if (verbose) cat(iterations, "permutations completed in", elapsed_time, "\n")

  # merge permutation data
  dri_shuffle <- bind_rows(dri_shuffle)
  
  raw <- bind_rows(raw, dri_shuffle)
  
  # calculate p
  p <- nrow(dri_shuffle %>% filter(dri >= obs_dri)) / nrow(dri_shuffle)
  
  #
  res <- tibble(
    n = nrow(data),
    obs_dri = obs_dri,
    n_perm = nrow(dri_shuffle),
    mean_perm_dri = mean(dri_shuffle$dri, na.rm = TRUE),
    p = p,
  )
  
  if (summary) return(res) else return (raw)
  
}
```



## Surveys and Roles: Are models trully consistent across roles?
```{r, fig.width=8, fig.height=12}
perms <- list()
summs <- list()
for (survey in cc_surveys) {
  
  for (role in cc_roles$uid) {
    
    # get data
    data <- llm_data %>% filter(survey == !!survey, prompt_uid == role) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    
    # get raw permutation data for plotting
    perm <- permute_dri(data, iterations = ITERATIONS, summary = FALSE)
    perm$survey <- survey
    perm$role <- role
    
    perms[[length(perms)+1]] <- perm
    
    # get summary for table
    summ <- summarize_perm_dri(perm)
    summ$survey <- survey
    summ$role <- role
    
    summs[[length(summs)+1]] <- summ

  }
  
}

perms <- bind_rows(perms)
summs <- bind_rows(summs)


perms %>%
  gghistogram(
    x = "dri",
    facet.by = c("role", "survey"),
    fill = "source",
    add = "mean",
    rug = TRUE,
    title = "Survey/Role Permutation Test",
    caption = paste(ITERATIONS, "permutations"),
  ) -> plot

plot

summs %>%
  arrange(p) %>%
  knitr::kable(caption = "Survey/Role Permutation Summary", digits = 3)
  
```


## Models and Surveys: Which models are consistent across roles?
```{r, fig.width=12, fig.height=10}
perms <- list()
summs <- list()
for (survey in cc_surveys) {
  
  for (model in models$model) {
    
    # get data (for climate roles only)
    data <- llm_data %>% filter(model == !!model, survey == !!survey, prompt_uid %in% cc_roles$uid) %>%
        mutate(pnum = row_number()) # treat each response as a participant
    
    # get raw permutation data for plotting
    perm <- permute_dri(data, iterations = ITERATIONS, summary = FALSE)
    perm$survey <- survey
    perm$model <- model
    
    perms[[length(perms)+1]] <- perm
    
    # get summary for table
    summ <- summarize_perm_dri(perm)
    summ$survey <- survey
    summ$model <- model
    
    summs[[length(summs)+1]] <- summ

  }
  
}

perms <- bind_rows(perms)
summs <- bind_rows(summs)


perms %>%
  gghistogram(
    x = "dri",
    facet.by = c("model", "survey"),
    fill = "source",
    add = "mean",
    rug = TRUE,
    title = "Survey/Model Permutation Test",
    caption = paste(ITERATIONS, "permutations"),
  ) -> plot


plot

summs %>%
  arrange(p) %>%
  knitr::kable(caption = "Survey/Model Permutation Summary", digits = 3)
  
```


# References
